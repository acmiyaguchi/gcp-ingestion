#!/bin/bash

# Update the BigQuery table schemas in the current project. Set the following
# environment variables to modify the behavior of the update.
#
#   SKIP_EXISTING=1     - Skip table creation if the table already exists
#   REPLACE_EXISTING=1  - Drop and create a table whether it exists or not
#
# The default behavior is to fail when encountering an existing table.

cd "$(dirname "$0")/.." || exit

if [[ ! -d "bq-schemas" ]]; then
    echo "Run 'bin/generate-bq-schemas'"
    exit 1
fi

total=0
skip=0
function update_table() {
    # Arguments:
    #   $1 - path to the document in format `{namespace}.{type}.{version}.bq.json`
    #
    # Options via envvar
    #   $SKIP_EXISTING  - skip if exists
    #   $REPLACE_EXISTING - remove and create if exists
    #
    # Counters:
    #   $total - the total number of documents seen
    #   $skip  - the number of documents that have been skipped
    document=$1

    # downcase hyphens to underscores before generating names
    bq_document=$(echo $(basename $document) | sed 's/-/_/g')
    namespace=$(echo $bq_document | cut -d. -f1)
    doctype=$(echo $bq_document | cut -d. -f2)
    docver=$(echo $bq_document | cut -d. -f3)

    if ! bq ls | grep ${namespace} >/dev/null ; then
        echo "creating dataset: ${namespace}"
        bq mk ${namespace}
    fi

    table_exists=$(bq ls ${namespace} | grep ${doctype}_v${docver})

    if [[ ! -z ${SKIP_EXISTING+x} ]] && [[ ! -z ${table_exists} ]]; then
        echo "skipping bq mk for ${document}"
        ((skip++))
        return
    fi

    if [[ ! -z ${REPLACE_EXISTING+x} ]] && [[ ! -z ${table_exists} ]]; then
        echo "running bq rm for ${document}"
        bq rm -f ${namespace}.${doctype}_v${docver}
    fi

    bq mk --table \
        --schema $document \
        --time_partitioning_field submission_timestamp \
        ${namespace}.${doctype}_v${docver}
}

documents=$(find bq-schemas -type file)
trap "exit" INT
for document in ${documents}; do
    update_table $document
done
echo "$((total-skip))/$total sucessfully updated, ${skip} skipped."
