#!/bin/bash

cd "$(dirname "$0")/.." || exit

if [[ ! -d bq-schemas ]]; then
    echo "Run 'bin/generate-bq-schemas'"
    exit 1
fi

documents=$(find bq-schemas -type file)

total=0
error=0
skip=0

trap "exit" INT
for document in ${documents}; do
    # downcase hyphens to underscores before generating names
    bq_document=$(echo $(basename $document) | sed 's/-/_/g')
    namespace=$(echo $bq_document | cut -d. -f1)
    doctype=$(echo $bq_document | cut -d. -f2)
    docver=$(echo $bq_document | cut -d. -f3)

    if ! bq ls | grep ${namespace} >/dev/null ; then
        echo "creating dataset: ${namespace}"
        bq mk ${namespace}
    fi

    table_exists=$(bq ls ${namespace} | grep ${doctype}_v${docver})

    if [[ ! -z ${SKIP_EXISTING+x} ]] && [[ ! -z ${table_exists} ]]; then
        echo "skipping bq mk for ${document}"
        ((skip++))
        continue
    fi

    if [[ ! -z ${REPLACE_EXISTING+x} ]] && [[ ! -z ${table_exists} ]]; then
        echo "running bq rm for ${document}"
        bq rm -f ${namespace}.${doctype}_v${docver}
    fi

    bq mk --table \
        --schema $document \
        --time_partitioning_field submission_timestamp \
        ${namespace}.${doctype}_v${docver}
done
